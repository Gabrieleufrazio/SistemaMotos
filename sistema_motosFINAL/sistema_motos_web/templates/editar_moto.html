{% extends "layout_base.html" %}
{% block titulo %}Editar Moto{% endblock %}
{% block content %}
<h4>‚úèÔ∏è Editar Moto</h4>

<form method="post" enctype="multipart/form-data">
  <div class="row">
    <div class="col-md-3 mb-3">
      <label>Marca</label>
      <input type="text" name="marca" value="{{ moto[1] }}" class="form-control" required>
    </div>
    <div class="col-md-3 mb-3">
      <label>Modelo</label>
      <input type="text" name="modelo" value="{{ moto[2] }}" class="form-control" required>
    </div>
    <div class="col-md-2 mb-3">
      <label>Ano</label>
      <input type="number" name="ano" value="{{ moto[3] }}" class="form-control" required>
    </div>
    <div class="col-md-2 mb-3">
      <label>Cor</label>
      <input type="text" name="cor" value="{{ moto[4] }}" class="form-control" required>
    </div>
    <div class="col-md-2 mb-3">
      <label>Quilometragem (KM)</label>
      <input type="text" name="km" id="km" value="{{ moto[5] }}" placeholder="Ex: 10.500" class="form-control" required>
    </div>
    <div class="col-md-2 mb-3">
      <label>Pre√ßo (R$)</label>
      <input type="text" name="preco" id="preco" value="{{ moto[6] }}" placeholder="Ex: R$ 12.990,50" class="form-control" required>
    </div>
    <div class="col-md-3 mb-3">
      <label>Placa</label>
      <input type="text" name="placa" value="{{ moto[7] }}" class="form-control" required>
    </div>
    <div class="col-md-3 mb-3">
      <label>Combust√≠vel</label>
      <select name="combustivel" class="form-control" required>
        {% for tipo in ["Gasolina", "√Ålcool", "Flex", "El√©trico"] %}
          <option value="{{ tipo }}" {% if moto[8] == tipo %}selected{% endif %}>{{ tipo }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 mb-3">
      <label>Status</label>
      <select name="status" class="form-control" required>
        {% for s in ["dispon√≠vel", "vendida", "consignado"] %}
          {% set s_lower = s|lower %}
          {% set current = (moto[9] or '')|lower %}
          {% set is_selected = (current == s_lower) or (s_lower == 'dispon√≠vel' and current == 'disponivel') %}
          <option value="{{ s }}" {% if is_selected %}selected{% endif %}>{{ s|capitalize }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 mb-3">
      <label>Renavam</label>
      <input type="text" name="renavam" value="{{ moto[10] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>Chassi</label>
      <input type="text" name="chassi" value="{{ moto[11] }}" class="form-control">
    </div>

    <div class="col-md-3 mb-3">
      <label>Data Cadastro</label>
      <input type="date" name="data_cadastro" value="{{ moto[15] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>Hora Cadastro</label>
      <input type="time" name="hora_cadastro" value="{{ moto[16] }}" class="form-control">
    </div>

    <div class="col-md-3 mb-3">
      <label>Nome Cliente</label>
      <input type="text" name="nome_cliente" value="{{ moto[17] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>CPF Cliente</label>
      <input type="text" name="cpf_cliente" value="{{ moto[18] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>Rua/Endere√ßo</label>
      <input type="text" name="rua_cliente" value="{{ moto[19] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>CEP Cliente</label>
      <input type="text" name="cep_cliente" value="{{ moto[20] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>Celular Cliente</label>
      <input type="text" name="celular_cliente" value="{{ moto[21] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>Refer√™ncia</label>
      <input type="text" name="referencia" value="{{ moto[22] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>Celular Refer√™ncia</label>
      <input type="text" name="celular_referencia" value="{{ moto[23] }}" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label>D√©bitos</label>
      <input type="text" name="debitos" value="{{ moto[24] }}" class="form-control">
    </div>
    <div class="col-md-12 mb-3">
      <label>Observa√ß√µes</label>
      <textarea name="observacoes" class="form-control" rows="3">{{ moto[25] }}</textarea>
    </div>

    <div class="col-md-4 mb-3">
      <label>Documento da Moto</label>
      <div class="d-flex align-items-center gap-2">
        {% set doc_url = file_url(moto[12]) %}
        {% if doc_url %}
          <a href="{{ doc_url }}" target="_blank" class="btn btn-sm btn-outline-info">Ver atual</a>
        {% endif %}
        <input type="file" name="doc_moto" class="form-control">
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <label>Documento do Fornecedor</label>
      <div class="d-flex align-items-center gap-2">
        {% set documento_fornecedor_url = file_url(moto[13]) %}
        {% if documento_fornecedor_url %}
          <a href="{{ documento_fornecedor_url }}" target="_blank" class="btn btn-sm btn-outline-info">Ver atual</a>
        {% endif %}
        <input type="file" name="documento_fornecedor" class="form-control">
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <label>Comprovante de Resid√™ncia</label>
      <div class="d-flex align-items-center gap-2">
        {% set extra_url = file_url(moto[14]) %}
        {% if extra_url %}
          <a href="{{ extra_url }}" target="_blank" class="btn btn-sm btn-outline-info">Ver atual</a>
        {% endif %}
        <input type="file" name="documento_extra" class="form-control">
      </div>
    </div>

    <div class="col-md-4 mb-3">
      <label>Foto da Moto</label>
      <div class="d-flex align-items-center gap-2">
        {% set foto_encontrada = false %}
        {% for ext in ['.jpg', '.jpeg', '.png', '.gif', '.webp'] if not foto_encontrada %}
          {% set foto_filename = 'foto_moto_' + moto[0]|string + ext %}
          {% if file_exists(foto_filename) %}
            <a href="{{ url_for('static', filename='uploads/' + foto_filename) }}" target="_blank" class="btn btn-sm btn-outline-info">Ver atual</a>
            {% set foto_encontrada = true %}
          {% endif %}
        {% endfor %}
        <input type="file" name="foto_moto" class="form-control" accept="image/*">
      </div>
      <small class="text-muted">Formatos aceitos: JPG, PNG, GIF, WEBP</small>
    </div>
  </div>
  <button type="submit" class="btn btn-success">üíæ Salvar Altera√ß√µes</button>
  <a href="/listar_motos" class="btn btn-secondary ms-2">‚Ü©Ô∏è Voltar</a>
</form>

<script>
// Helpers de normaliza√ß√£o e formata√ß√£o
function parseNumeroBR(valor) {
  if (valor == null) return null;
  valor = String(valor).trim();
  if (valor === '') return null;
  // Aceita "1.234,56", "1234,56", "1234.56" ou "123456"
  // Primeiro, remove espa√ßos e s√≠mbolo de moeda
  valor = valor.replace(/R\$\s?/g, '');
  // Se tiver v√≠rgula, considere como separador decimal BR
  if (valor.includes(',')) {
    valor = valor.replace(/\./g, '').replace(',', '.');
  }
  // Agora deve estar no padr√£o com ponto decimal
  const n = Number(valor);
  return isNaN(n) ? null : n;
}

function formatarKMDeNumero(n) {
  if (n == null || isNaN(n)) return '';
  // KM sem casas decimais, milhares com ponto
  return Math.floor(n).toLocaleString('pt-BR');
}

function formatarPrecoDeNumero(n) {
  if (n == null || isNaN(n)) return '';
  return 'R$ ' + Number(n).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Formata√ß√£o durante digita√ß√£o (comportamento igual ao cadastro)
function formatarKMInput(valor) {
  return valor.replace(/\D/g, '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
}

function formatarPrecoInput(valor) {
  valor = valor.replace(/\D/g, '');
  valor = (valor / 100).toFixed(2) + '';
  valor = valor.replace('.', ',');
  valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, '$1.$2.$3,');
  valor = valor.replace(/(\d)(\d{3}),/g, '$1.$2,');
  return 'R$ ' + valor;
}

// Aplicar formata√ß√£o inicial ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
  const kmEl = document.getElementById('km');
  const precoEl = document.getElementById('preco');
  if (kmEl && kmEl.value) {
    const n = parseNumeroBR(kmEl.value);
    kmEl.value = formatarKMDeNumero(n);
  }
  if (precoEl && precoEl.value) {
    const n = parseNumeroBR(precoEl.value);
    precoEl.value = formatarPrecoDeNumero(n);
  }

  // Eventos de digita√ß√£o
  kmEl.addEventListener('input', function(e) {
    e.target.value = formatarKMInput(e.target.value);
  });
  precoEl.addEventListener('input', function(e) {
    e.target.value = formatarPrecoInput(e.target.value);
  });

  // Limpeza antes de enviar (igual cadastro)
  document.querySelector('form').addEventListener('submit', function() {
    // KM: apenas d√≠gitos
    kmEl.value = kmEl.value.replace(/\./g, '');
    // Pre√ßo: remove R$ e pontos, mant√©m v√≠rgula
    precoEl.value = precoEl.value.replace(/R\$\s?/, '').replace(/\./g, '');
  });
});
</script>
{% endblock %}