<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .btn {
            border-radius: 10px;
            font-weight: 600;
        }
        .table {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
        }
        .alert {
            border-radius: 10px;
        }
        /* Categorias: lista mais curta e compacta */
        .categories-list {
            max-height: 220px;
            overflow: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .categories-list .list-group-item {
            padding: 6px 10px;
        }
        .categories-list .btn.btn-sm {
            padding: 2px 8px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card p-4 text-center">
                    <h1 class="display-4 text-primary mb-2">üí∞ Controle Financeiro</h1>
                    <p class="text-muted">Dashboard integrado de receitas e despesas</p>
                    <a href="/menu" class="btn btn-outline-secondary">‚Üê Voltar ao Menu</a>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Dashboard Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="dashboard-card p-4 text-center text-white bg-success">
                    <h5>üíµ Receitas Totais</h5>
                    <h2>R$ {{ "{:,.2f}".format(valores_bar[0]).replace(",", "v").replace(".", ",").replace("v", ".") }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card p-4 text-center text-white bg-danger">
                    <h5>üí∏ Gastos Totais</h5>
                    <h2>R$ {{ "{:,.2f}".format(valores_bar[1]).replace(",", "v").replace(".", ",").replace("v", ".") }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card p-4 text-center text-white {{ 'bg-success' if valores_bar[2] >= 0 else 'bg-warning' }}">
                    <h5>üìä Saldo</h5>
                    <h2>R$ {{ "{:,.2f}".format(valores_bar[2]).replace(",", "v").replace(".", ",").replace("v", ".") }}</h2>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="dashboard-card p-4">
                    <h5 class="text-center mb-3">üìà Resumo Financeiro</h5>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card p-4">
                    <h5 class="text-center mb-3">ü•ß Gastos por Categoria</h5>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forms Row -->
        <div class="row mb-4">
            <!-- Add Category -->
            <div class="col-md-4">
              <div class="dashboard-card p-4">
                <h5 class="text-primary mb-3">üìù Nova Categoria</h5>
                <form method="POST" action="/inserir_categoria_financeira">
                  <div class="mb-3">
                    <input type="text" class="form-control" name="nome_categoria" placeholder="Nome da categoria" required>
                  </div>
                  <button type="submit" class="btn btn-primary w-100">Adicionar Categoria</button>
                </form>
                <hr class="my-4">
                <h6 class="text-secondary">Categorias existentes</h6>
                {% if categorias and categorias|length > 0 %}
                  <div class="list-group small">
                    {% for cat in categorias %}
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ cat[1] }}</span>
                        <form method="POST" action="/deletar_categoria_financeira/{{ cat[0] }}" onsubmit="return confirm('Excluir esta categoria? Itens j√° lan√ßados manter√£o o nome antigo.');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è Excluir</button>
                        </form>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-muted">Nenhuma categoria cadastrada.</div>
                {% endif %}
              </div>
            </div>

            <!-- Add Income -->
            <div class="col-md-4">
                <div class="dashboard-card p-4">
                    <h5 class="text-success mb-3">üíµ Nova Receita</h5>
                    <form method="POST" action="/inserir_receita_financeira">
                        <div class="mb-3">
                            <input type="date" class="form-control" name="data_receita" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" name="valor_receita" placeholder="R$ 0,00" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Adicionar Receita</button>
                    </form>
                </div>
            </div>

            <!-- Add Expense -->
            <div class="col-md-4">
                <div class="dashboard-card p-4">
                    <h5 class="text-danger mb-3">üí∏ Novo Gasto</h5>
                    <form method="POST" action="/inserir_gasto_financeiro">
                        <div class="mb-3">
                            <select class="form-select" name="categoria_gasto" required>
                                <option value="">Selecione a categoria</option>
                                {% for categoria in categorias %}
                                    <option value="{{ categoria[1] }}">{{ categoria[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <input type="date" class="form-control" name="data_gasto" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" name="valor_gasto" placeholder="R$ 0,00" required>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">Adicionar Gasto</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card p-4">
                    <h5 class="text-primary mb-3">üìã Hist√≥rico de Transa√ß√µes</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Categoria</th>
                                    <th>Data</th>
                                    <th>Valor</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in dados_tabela %}
                                <tr>
                                    <td>
                                        {% if item.tipo == 'receita' %}
                                            <span class="badge bg-success">üíµ Receita</span>
                                        {% else %}
                                            <span class="badge bg-danger">üí∏ Gasto</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.categoria }}</td>
                                    <td>{{ item.data }}</td>
                                    <td class="{{ 'text-success' if item.tipo == 'receita' else 'text-danger' }}">
                                        {{ item.valor_formatado }}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-item"
                                                    data-item-id="{{ item.id }}"
                                                    data-item-tipo="{{ item.tipo }}"
                                                    data-item-categoria="{{ item.categoria }}"
                                                    data-item-data="{{ item.data }}"
                                                    data-item-valor="{{ item.valor }}"
                                                    data-bs-toggle="modal" data-bs-target="#modalEditarItem">
                                                ‚úèÔ∏è Editar
                                            </button>
                                            <a href="/deletar_item_financeiro/{{ item.tipo }}/{{ item.id }}" 
                                               class="btn btn-sm btn-outline-danger"
                                               onclick="return confirm('Tem certeza que deseja deletar este item?')">
                                                üóëÔ∏è Deletar
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Item -->
    <div class="modal fade" id="modalEditarItem" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formEditarItem" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-control" name="categoria" id="editCategoria">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data</label>
                            <input type="date" class="form-control" name="data" id="editData">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="text" class="form-control" name="valor" id="editValor" placeholder="R$ 0,00">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Preencher modal de edi√ß√£o ao clicar no bot√£o Editar
        document.addEventListener('click', function(ev){
            const btn = ev.target.closest('.btn-edit-item');
            if (!btn) return;
            const id = btn.getAttribute('data-item-id');
            const tipo = btn.getAttribute('data-item-tipo');
            const categoria = btn.getAttribute('data-item-categoria') || '';
            const dataOrig = btn.getAttribute('data-item-data') || '';
            const valor = btn.getAttribute('data-item-valor') || '';

            // Converter data DD/MM/YYYY -> YYYY-MM-DD para input date
            let dataIso = '';
            const m = dataOrig.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (m) { dataIso = `${m[3]}-${m[2]}-${m[1]}`; }

            document.getElementById('editCategoria').value = categoria;
            document.getElementById('editData').value = dataIso;
            // Formatar valor no padr√£o BRL no input
            try {
                const v = parseFloat(valor);
                if (!isNaN(v)) {
                    let br = (v).toFixed(2).replace('.', ',');
                    br = br.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    document.getElementById('editValor').value = 'R$ ' + br;
                } else {
                    document.getElementById('editValor').value = '';
                }
            } catch(e) { document.getElementById('editValor').value = ''; }

            // Definir action do form conforme tipo
            const form = document.getElementById('formEditarItem');
            form.action = `/editar_item_financeiro/${tipo}/${id}`;
        });

        // M√°scara simples BRL para o input de valor do modal
        document.getElementById('editValor').addEventListener('input', function(e){
            let value = e.target.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2);
            value = value.replace('.', ',');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            e.target.value = 'R$ ' + value;
        });
        // Preparar dados vindos do servidor (string JSON -> parse) para evitar erros do linter
        const valoresBar = JSON.parse('{{ valores_bar | tojson | safe }}');
        const pizzaLabels = JSON.parse('{{ valores_pizza[0] | tojson | safe }}');
        const pizzaData = JSON.parse('{{ valores_pizza[1] | tojson | safe }}');

        // Bar Chart
        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ['Receitas', 'Gastos', 'Saldo'],
                datasets: [{
                    data: valoresBar,
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        (valoresBar && valoresBar.length > 2 && valoresBar[2] >= 0) ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(220, 53, 69, 1)',
                        (valoresBar && valoresBar.length > 2 && valoresBar[2] >= 0) ? 'rgba(40, 167, 69, 1)' : 'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        }
                    }
                }
            }
        });

        // Pie Chart
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: pizzaLabels,
                datasets: [{
                    data: pizzaData,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Format currency inputs
        document.querySelectorAll('input[name="valor_receita"], input[name="valor_gasto"]').forEach(input => {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = (value / 100).toFixed(2);
                value = value.replace('.', ',');
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = 'R$ ' + value;
            });
        });
    </script>
</body>
</html>
