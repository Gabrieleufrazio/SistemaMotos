{% extends "layout_base.html" %}
{% block titulo %}Lista de Motos{% endblock %}
{% block content %}
<h4>ğŸ“ƒ Motos Cadastradas</h4>
<style>
  /* Compactar a tabela desta pÃ¡gina */
  .table.table-sm td, .table.table-sm th {
    padding: 0.45rem 0.6rem; /* levemente maior para dar mais respiro */
  }
  /* Miniaturas um pouco menores para reduzir a altura da linha */
  .table.table-sm img.img-thumbnail {
    height: 40px !important;
  }
  /* Reduzir um pouco o preenchimento dos botÃµes pequenos */
  .table.table-sm .btn.btn-sm {
    padding: 0.15rem 0.35rem;
  }
  /* Diminuir leve espaÃ§amento horizontal entre itens visuais */
  .table.table-sm .img-thumbnail.me-1 { margin-right: 0.2rem !important; }
  /* Garantir que os botÃµes de documentos nunca se sobreponham */
  .docs-td .docs-wrap .btn {
    display: block;           /* um por linha para os principais */
    width: 100%;              /* ocupa a largura da cÃ©lula */
    white-space: nowrap;      /* mantÃ©m compacto */
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;         /* leitura melhor quando largo */
    border-radius: 10px;
    border-width: 1px;
    padding: 0.25rem 0.5rem;
  }
  /* EspaÃ§amento e largura mÃ­nima da coluna de documentos */
  td.docs-td { min-width: 220px; }
  .docs-td .docs-wrap { display: grid; gap: 8px; }
  /* ExceÃ§Ã£o: Doc Extra + ProcuraÃ§Ã£o lado a lado em duas colunas responsivas */
  .docs-td .docs-wrap .docs-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .docs-td .docs-wrap .docs-inline .btn { width: 100%; text-align: center; }
  /* AparÃªncia mais suave para os botÃµes sÃ³ nesta coluna */
  .docs-td a.btn.btn-outline-info { background: #f7fafc; border-color: #cfd7e1; color: #1f4e79; }
  .docs-td a.btn.btn-outline-info:hover { background: #e9f2fb; border-color: #b5c5da; color: #143a5a; }
  .docs-td a.btn.btn-outline-secondary { background: #f8f9fb; border-color: #d7dbe2; color: #495057; }
  .docs-td a.btn.btn-outline-secondary:hover { background: #eceff4; border-color: #c6ccd6; color: #343a40; }

  /* Destacar motos consignadas (linha em tom de vermelho claro) */
  tr.consignado-row { background-color: #ffe5e5; }

  /* AÃ§Ãµes: compactar e evitar que aumente a altura da linha */
  td.acoes-td { min-width: 210px; }
  .acoes-wrap { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
  .acoes-wrap .btn { padding: 0.12rem 0.4rem; line-height: 1.1; white-space: nowrap; }
</style>

<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input type="text" name="marca_modelo" value="{{ filtros.marca_modelo }}" class="form-control" placeholder="ğŸ”¤ Marca ou Modelo">
  </div>
  <div class="col-md-2">
    <input type="text" name="placa" value="{{ filtros.placa }}" class="form-control" placeholder="ğŸ“ Placa">
  </div>
  <div class="col-md-2">
    <input type="text" name="renavam" value="{{ filtros.renavam }}" class="form-control" placeholder="ğŸ“ Renavam">
  </div>
  <div class="col-md-2">
    <select name="combustivel" class="form-control">
      <option value="">â›½ CombustÃ­vel</option>
      {% for c in ["Gasolina", "Etanol", "Flex", "ElÃ©trico"] %}
        <option value="{{ c }}" {% if filtros.combustivel == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_min" value="{{ filtros.ano_min }}" class="form-control" placeholder="ğŸ“† Ano mÃ­n">
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_max" value="{{ filtros.ano_max }}" class="form-control" placeholder="ğŸ“† Ano mÃ¡x">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_min" value="{{ filtros.km_min }}" class="form-control" placeholder="ğŸ›£ï¸ Km mÃ­n">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_max" value="{{ filtros.km_max }}" class="form-control" placeholder="ğŸ›£ï¸ Km mÃ¡x">
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_min" value="{{ filtros.preco_min }}" class="form-control" placeholder="ğŸ’° PreÃ§o mÃ­n">
    {% endif %}
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_max" value="{{ filtros.preco_max }}" class="form-control" placeholder="ğŸ’° PreÃ§o mÃ¡x">
    {% endif %}
  </div>
  <div class="col-md-2">
    <select name="status" class="form-control">
      <option value="">ğŸ“Š Status</option>
      {% for s in ["disponÃ­vel", "vendida", "consignado"] %}
        <option value="{{ s }}" {% if filtros.status == s %}selected{% endif %}>{{ s|capitalize }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">ğŸ” Filtrar</button>
  </div>
</form>

{% if motos %}
<table class="table table-bordered table-striped table-sm">
  <thead class="table-dark">
    <tr>
      <th>ID</th><th>Marca</th><th>Modelo</th><th>Ano</th><th>Cor</th>
      <th>Km</th>
      {% if session.tipo == 'admin' %}
        <th>PreÃ§o cadastrado</th><th>Vendido por</th><th>Lucro</th>
      {% else %}
        <th>PreÃ§o</th>
      {% endif %}
      <th>Placa</th><th>CombustÃ­vel</th><th>Status</th><th>Foto</th><th>Documentos</th><th>Documentos Venda</th><th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody>
    {% for m in motos %}
    {% set st = (m[9] or '')|lower %}
    <tr class="{% if st == 'consignado' %}consignado-row{% endif %}">
      <td>{{ m[0] }}</td><td>{{ m[1] }}</td><td>{{ m[2] }}</td><td>{{ m[3] }}</td><td>{{ m[4] }}</td>
      <td>{{ m[5]|br_km }}</td>
      {% if session.tipo == 'admin' %}
        <td>{{ m[6]|br_moeda }}</td>
        <td>
          {% set pv = sale_prices.get(m[0]) if sale_prices else None %}
          {% if pv is not none %}
            {{ pv|br_moeda }}
          {% else %}
            â€”
          {% endif %}
        </td>
        <td>
          {% if pv is not none %}
            {% set lucro = pv - (m[6]|float) %}
            {{ lucro|br_moeda }}
          {% else %}
            â€”
          {% endif %}
        </td>
      {% else %}
        <td>â€”</td>
      {% endif %}
      <td>{{ m[7] }}</td>
      <td>{{ m[8] }}</td>
      <td>
        {% if st == 'vendida' %}
          <span style="color: red; font-weight: bold;">{{ m[9]|capitalize }}</span>
        {% elif st == 'consignado' %}
          <span style="color: red; font-weight: bold;">{{ m[9]|capitalize }}</span>
        {% elif st == 'disponÃ­vel' or st == 'disponivel' %}
          <span style="color: green; font-weight: bold;">{{ m[9]|capitalize }}</span>
        {% else %}
          <span>{{ m[9]|capitalize }}</span>
        {% endif %}
      </td>
      <td>
        {% if foto_urls and (m[0] in foto_urls) %}
          <a href="{{ foto_urls[m[0]] }}" target="_blank" title="Foto da Moto">
            <img src="{{ foto_urls[m[0]] }}" alt="Foto da Moto" class="img-thumbnail me-1" style="height:48px; width:auto;">
          </a>
        {% else %}
          â€”
        {% endif %}
      </td>
      <td class="docs-td" style="vertical-align: top;">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            ğŸ“ Documentos
          </button>
          <ul class="dropdown-menu">
            {% set doc_url = file_url(m[12]) %}
            {% if doc_url %}
              <li><a class="dropdown-item" href="{{ doc_url }}" target="_blank">ğŸ“„ Documento Moto</a></li>
            {% endif %}
            {% set documento_fornecedor_url = file_url(m[13]) %}
            {% if documento_fornecedor_url %}
              <li><a class="dropdown-item" href="{{ documento_fornecedor_url }}" target="_blank">ğŸ· Fornecedor</a></li>
            {% endif %}
            {% set resid_url = file_url(m[14]) %}
            {% if resid_url %}
              <li><a class="dropdown-item" href="{{ resid_url }}" target="_blank">ğŸ  Comprovante de ResidÃªncia</a></li>
            {% endif %}
            {% if procuracao_urls and procuracao_urls.get(m[0]) %}
              <li><a class="dropdown-item" href="{{ procuracao_urls.get(m[0]) }}" target="_blank">ğŸ“ ProcuraÃ§Ã£o</a></li>
            {% endif %}
            {% if not (doc_url or documento_fornecedor_url or resid_url or (procuracao_urls and procuracao_urls.get(m[0])) or (anexos_venda and anexos_venda.get(m[0]) and anexos_venda.get(m[0])['cnh'])) %}
              <li><span class="dropdown-item text-muted">Sem documentos</span></li>
            {% endif %}
          </ul>
        </div>
      </td>
      <td class="docs-td" style="vertical-align: top;">
        {% set venda_docs = anexos_venda.get(m[0]) if anexos_venda else None %}
        {% if venda_docs and (venda_docs['cnh'] or venda_docs['garantia'] or venda_docs['endereco']) %}
          <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              ğŸ“ Documentos Venda
            </button>
            <ul class="dropdown-menu">
              {% if venda_docs['cnh'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['cnh'] }}" target="_blank">ğŸªª CNH</a></li>
              {% endif %}
              {% if venda_docs['garantia'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['garantia'] }}" target="_blank">ğŸ“‹ Garantia</a></li>
              {% endif %}
              {% if venda_docs['endereco'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['endereco'] }}" target="_blank">ğŸ  EndereÃ§o</a></li>
              {% endif %}
            </ul>
          </div>
        {% else %}
          â€”
        {% endif %}
      </td>
      <td class="acoes-td">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            âš™ï¸ AÃ§Ãµes
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/editar_moto/{{ m[0] }}">âœï¸ Editar</a></li>
            <li><a class="dropdown-item text-danger" href="/excluir_moto/{{ m[0] }}" onclick="return confirm('Confirma exclusÃ£o?')">ğŸ—‘ï¸ Excluir</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button type="button" class="dropdown-item btn-print-docs" data-moto-id="{{ m[0] }}">ğŸ–¨ï¸ Imprimir Docs</button></li>
            <li><button type="button" class="dropdown-item btn-print-foto" data-moto-id="{{ m[0] }}">ğŸ–¨ï¸ Imprimir Foto</button></li>
            <li><button type="button" class="dropdown-item btn-print-todos" data-moto-id="{{ m[0] }}">ğŸ–¨ï¸ Imprimir Tudo</button></li>
          </ul>
        </div>
        <!-- Container oculto com URLs para impressÃ£o desta moto -->
        <div id="print-urls-{{ m[0] }}" class="d-none">
          {% if foto_urls and (m[0] in foto_urls) %}
            <span data-url-foto="{{ foto_urls[m[0]] }}"></span>
          {% endif %}
          {% if doc_url %}
            <span data-url-doc="{{ doc_url }}"></span>
          {% endif %}
          {% if documento_fornecedor_url %}
            <span data-url-doc-fornecedor="{{ documento_fornecedor_url }}"></span>
          {% endif %}
          {% if resid_url %}
            <span data-url-resid="{{ resid_url }}"></span>
          {% endif %}
          {% if procuracao_urls and procuracao_urls.get(m[0]) %}
            <span data-url-procuracao="{{ procuracao_urls.get(m[0]) }}"></span>
          {% endif %}
          {# Incluir CNH na fila de impressÃ£o, se existir #}
          {% if anexos_venda and anexos_venda.get(m[0]) and anexos_venda.get(m[0])['cnh'] %}
            <span data-url-doc="{{ anexos_venda.get(m[0])['cnh'] }}"></span>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <div class="alert alert-info">Nenhuma moto encontrada com os filtros aplicados.</div>
{% endif %}

<a href="/cadastro_moto" class="btn btn-success mt-3">â• Cadastrar Nova Moto</a>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-print-docs, .btn-print-foto, .btn-print-todos');
    if (!btn) return;
    const id = btn.getAttribute('data-moto-id');
    if (!id) return;
    if (btn.classList.contains('btn-print-docs')) return imprimirDocs(id);
    if (btn.classList.contains('btn-print-foto')) return imprimirFoto(id);
    if (btn.classList.contains('btn-print-todos')) return imprimirTudo(id);
  });
  function abrirImprimirUrl(url, cb){
    try {
      const w = window.open(url, '_blank');
      setTimeout(() => {
        try { if (w) { w.focus(); w.print(); } } catch(e) {}
        if (typeof cb === 'function') setTimeout(cb, 700);
      }, 800);
    } catch(e) {
      if (typeof cb === 'function') cb();
    }
  }

  function coletarUrls(motoId){
    const cont = document.querySelector('#print-urls-' + motoId);
    if (!cont) return {foto:null, docs:[]};
    const fotoEl = cont.querySelector('[data-url-foto]');
    const urls = [];
    ['data-url-doc','data-url-doc-fornecedor','data-url-resid','data-url-procuracao']
      .forEach(attr => cont.querySelectorAll('['+attr+']').forEach(el => urls.push(el.getAttribute(attr))));
    return { foto: fotoEl ? fotoEl.getAttribute('data-url-foto') : null, docs: urls };
  }

  function imprimirDocs(motoId){
    const {docs} = coletarUrls(motoId);
    if (!docs.length) return;
    let i = 0;
    const prox = () => { if (i < docs.length) abrirImprimirUrl(docs[i++], prox); };
    prox();
  }

  function imprimirFoto(motoId){
    const {foto} = coletarUrls(motoId);
    if (!foto) return;
    abrirImprimirUrl(foto);
  }

  function imprimirTudo(motoId){
    const {foto, docs} = coletarUrls(motoId);
    const fila = [...docs];
    if (foto) fila.unshift(foto); // imprime a foto primeiro
    if (!fila.length) return;
    let i = 0;
    const prox = () => { if (i < fila.length) abrirImprimirUrl(fila[i++], prox); };
    prox();
  }
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-danger[data-confirm]');
    if (!btn) return;
    if (!confirm(btn.getAttribute('data-confirm'))) e.preventDefault();
  });
</script>
{% endblock %}