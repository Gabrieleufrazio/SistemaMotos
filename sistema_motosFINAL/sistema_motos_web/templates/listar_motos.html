{% extends "layout_base.html" %}
{% block titulo %}Lista de Motos{% endblock %}
{% block content %}
<h4>üìÉ Motos Cadastradas</h4>
<style>
  /* Compactar a tabela desta p√°gina */
  .table.table-sm td, .table.table-sm th {
    padding: 0.2rem 0.35rem; /* menor que o padr√£o do .table-sm */
  }
  /* Miniaturas um pouco menores para reduzir a altura da linha */
  .table.table-sm img.img-thumbnail {
    height: 40px !important;
  }
  /* Reduzir um pouco o preenchimento dos bot√µes pequenos */
  .table.table-sm .btn.btn-sm {
    padding: 0.15rem 0.35rem;
  }
  /* Diminuir leve espa√ßamento horizontal entre itens visuais */
  .table.table-sm .img-thumbnail.me-1 { margin-right: 0.2rem !important; }
</style>

<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input type="text" name="marca_modelo" value="{{ filtros.marca_modelo }}" class="form-control" placeholder="üî§ Marca ou Modelo">
  </div>
  <div class="col-md-2">
    <input type="text" name="placa" value="{{ filtros.placa }}" class="form-control" placeholder="üìç Placa">
  </div>
  <div class="col-md-2">
    <input type="text" name="renavam" value="{{ filtros.renavam }}" class="form-control" placeholder="üìù Renavam">
  </div>
  <div class="col-md-2">
    <select name="combustivel" class="form-control">
      <option value="">‚õΩ Combust√≠vel</option>
      {% for c in ["Gasolina", "Etanol", "Flex", "El√©trico"] %}
        <option value="{{ c }}" {% if filtros.combustivel == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_min" value="{{ filtros.ano_min }}" class="form-control" placeholder="üìÜ Ano m√≠n">
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_max" value="{{ filtros.ano_max }}" class="form-control" placeholder="üìÜ Ano m√°x">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_min" value="{{ filtros.km_min }}" class="form-control" placeholder="üõ£Ô∏è Km m√≠n">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_max" value="{{ filtros.km_max }}" class="form-control" placeholder="üõ£Ô∏è Km m√°x">
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_min" value="{{ filtros.preco_min }}" class="form-control" placeholder="üí∞ Pre√ßo m√≠n">
    {% endif %}
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_max" value="{{ filtros.preco_max }}" class="form-control" placeholder="üí∞ Pre√ßo m√°x">
    {% endif %}
  </div>
  <div class="col-md-2">
    <select name="status" class="form-control">
      <option value="">üìä Status</option>
      {% for s in ["dispon√≠vel", "vendida"] %}
        <option value="{{ s }}" {% if filtros.status == s %}selected{% endif %}>{{ s|capitalize }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">üîé Filtrar</button>
  </div>
</form>

{% if motos %}
<table class="table table-bordered table-striped table-sm">
  <thead class="table-dark">
    <tr>
      <th>ID</th><th>Marca</th><th>Modelo</th><th>Ano</th><th>Cor</th>
      <th>Km</th>
      {% if session.tipo == 'admin' %}
        <th>Pre√ßo cadastrado</th><th>Vendido por</th><th>Lucro</th>
      {% else %}
        <th>Pre√ßo</th>
      {% endif %}
      <th>Placa</th><th>Combust√≠vel</th><th>Status</th><th>Foto</th><th>Documentos</th><th>Observa√ß√µes</th><th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody>
    {% for m in motos %}
    <tr>
      <td>{{ m[0] }}</td><td>{{ m[1] }}</td><td>{{ m[2] }}</td><td>{{ m[3] }}</td><td>{{ m[4] }}</td>
      <td>{{ m[5]|br_km }}</td>
      {% if session.tipo == 'admin' %}
        <td>{{ m[6]|br_moeda }}</td>
        <td>
          {% set pv = sale_prices.get(m[0]) if sale_prices else None %}
          {% if pv is not none %}
            {{ pv|br_moeda }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>
          {% if pv is not none %}
            {% set lucro = pv - (m[6]|float) %}
            {{ lucro|br_moeda }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      {% else %}
        <td>‚Äî</td>
      {% endif %}
      <td>{{ m[7] }}</td>
      <td>{{ m[8] }}</td>
      <td>
        {% if m[9] == 'vendida' %}
          <span style="color: red; font-weight: bold;">{{ m[9]|capitalize }}</span>
        {% elif m[9] == 'dispon√≠vel' %}
          <span style="color: green; font-weight: bold;">{{ m[9]|capitalize }}</span>
        {% else %}
          <span>{{ m[9]|capitalize }}</span>
        {% endif %}
      </td>
      <td>
        {% if foto_urls and (m[0] in foto_urls) %}
          <a href="{{ foto_urls[m[0]] }}" target="_blank" title="Foto da Moto">
            <img src="{{ foto_urls[m[0]] }}" alt="Foto da Moto" class="img-thumbnail me-1" style="height:48px; width:auto;">
          </a>
        {% else %}
          ‚Äî
        {% endif %}
      </td>
      <td>
        {% set doc_url = file_url(m[12]) %}
        {% if doc_url %}
          <a href="{{ doc_url }}" target="_blank" class="btn btn-sm btn-outline-info">Doc</a>
        {% endif %}
        {% set documento_fornecedor_url = file_url(m[13]) %}
        {% if documento_fornecedor_url %}
          <a href="{{ documento_fornecedor_url }}" target="_blank" class="btn btn-sm btn-outline-info">Doc Fornecedor</a>
        {% endif %}
        {% set resid_url = file_url(m[14]) %}
        {% if resid_url %}
          <a href="{{ resid_url }}" target="_blank" class="btn btn-sm btn-outline-info">Doc Extra</a>
        {% endif %}
        {# CNH da √∫ltima venda, se houver - sempre como bot√£o #}
        {% if anexos_venda and anexos_venda.get(m[0]) and anexos_venda.get(m[0])['cnh'] %}
          {% set cnh_link = anexos_venda.get(m[0])['cnh'] %}
          <a href="{{ cnh_link }}" target="_blank" class="btn btn-sm btn-outline-secondary">CNH</a>
        {% endif %}
        {% if procuracao_urls and procuracao_urls.get(m[0]) %}
          <a href="{{ procuracao_urls.get(m[0]) }}" target="_blank" class="btn btn-sm btn-outline-secondary">Procura√ß√£o</a>
        {% endif %}
      </td>
      <td>
        {% set obs = m[25] %}
        {% if obs %}
          {{ obs[:80] }}{% if obs|length > 80 %}...{% endif %}
        {% else %}
          ‚Äî
        {% endif %}
      </td>
      <td>
        <a href="/editar_moto/{{ m[0] }}" class="btn btn-sm btn-warning">‚úèÔ∏è Editar</a>
        <a href="/excluir_moto/{{ m[0] }}" class="btn btn-sm btn-danger" onclick="return confirm('Confirma exclus√£o?')">üóëÔ∏è Excluir</a>
        <div class="mt-1"></div>
        <!-- Bot√µes de impress√£o -->
        <button type="button" class="btn btn-sm btn-outline-primary btn-print-docs" data-moto-id="{{ m[0] }}">üñ®Ô∏è Docs</button>
        <button type="button" class="btn btn-sm btn-outline-success btn-print-foto" data-moto-id="{{ m[0] }}">üñ®Ô∏è Moto</button>
        <button type="button" class="btn btn-sm btn-outline-dark btn-print-todos" data-moto-id="{{ m[0] }}">üñ®Ô∏è Todos</button>
        <!-- Container oculto com URLs para impress√£o desta moto -->
        <div id="print-urls-{{ m[0] }}" class="d-none">
          {% if foto_urls and (m[0] in foto_urls) %}
            <span data-url-foto="{{ foto_urls[m[0]] }}"></span>
          {% endif %}
          {% if doc_url %}
            <span data-url-doc="{{ doc_url }}"></span>
          {% endif %}
          {% if documento_fornecedor_url %}
            <span data-url-doc-fornecedor="{{ documento_fornecedor_url }}"></span>
          {% endif %}
          {% if resid_url %}
            <span data-url-resid="{{ resid_url }}"></span>
          {% endif %}
          {% if procuracao_urls and procuracao_urls.get(m[0]) %}
            <span data-url-procuracao="{{ procuracao_urls.get(m[0]) }}"></span>
          {% endif %}
          {# Incluir CNH na fila de impress√£o, se existir #}
          {% if anexos_venda and anexos_venda.get(m[0]) and anexos_venda.get(m[0])['cnh'] %}
            <span data-url-doc="{{ anexos_venda.get(m[0])['cnh'] }}"></span>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <div class="alert alert-info">Nenhuma moto encontrada com os filtros aplicados.</div>
{% endif %}

<a href="/cadastro_moto" class="btn btn-success mt-3">‚ûï Cadastrar Nova Moto</a>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-print-docs, .btn-print-foto, .btn-print-todos');
    if (!btn) return;
    const id = btn.getAttribute('data-moto-id');
    if (!id) return;
    if (btn.classList.contains('btn-print-docs')) return imprimirDocs(id);
    if (btn.classList.contains('btn-print-foto')) return imprimirFoto(id);
    if (btn.classList.contains('btn-print-todos')) return imprimirTudo(id);
  });
  function abrirImprimirUrl(url, cb){
    try {
      const w = window.open(url, '_blank');
      setTimeout(() => {
        try { if (w) { w.focus(); w.print(); } } catch(e) {}
        if (typeof cb === 'function') setTimeout(cb, 700);
      }, 800);
    } catch(e) {
      if (typeof cb === 'function') cb();
    }
  }

  function coletarUrls(motoId){
    const cont = document.querySelector('#print-urls-' + motoId);
    if (!cont) return {foto:null, docs:[]};
    const fotoEl = cont.querySelector('[data-url-foto]');
    const urls = [];
    ['data-url-doc','data-url-doc-fornecedor','data-url-resid','data-url-procuracao']
      .forEach(attr => cont.querySelectorAll('['+attr+']').forEach(el => urls.push(el.getAttribute(attr))));
    return { foto: fotoEl ? fotoEl.getAttribute('data-url-foto') : null, docs: urls };
  }

  function imprimirDocs(motoId){
    const {docs} = coletarUrls(motoId);
    if (!docs.length) return;
    let i = 0;
    const prox = () => { if (i < docs.length) abrirImprimirUrl(docs[i++], prox); };
    prox();
  }

  function imprimirFoto(motoId){
    const {foto} = coletarUrls(motoId);
    if (!foto) return;
    abrirImprimirUrl(foto);
  }

  function imprimirTudo(motoId){
    const {foto, docs} = coletarUrls(motoId);
    const fila = [...docs];
    if (foto) fila.unshift(foto); // imprime a foto primeiro
    if (!fila.length) return;
    let i = 0;
    const prox = () => { if (i < fila.length) abrirImprimirUrl(fila[i++], prox); };
    prox();
  }
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-danger[data-confirm]');
    if (!btn) return;
    if (!confirm(btn.getAttribute('data-confirm'))) e.preventDefault();
  });
</script>
{% endblock %}