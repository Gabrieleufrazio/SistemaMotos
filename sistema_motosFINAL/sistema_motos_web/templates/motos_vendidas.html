{% extends "layout_base.html" %}
{% block titulo %}Motos Vendidas{% endblock %}
{% block content %}
<h4>ğŸ Motos Vendidas</h4>
<style>
  /* Destacar motos consignadas (vermelho claro) na listagem de vendidas se aparecerem */
  tr.consignado-row { background-color: #ffe5e5; }
  .table.table-sm { font-size: 0.92rem; }
  .table.table-sm img.img-thumbnail { height: 36px !important; }
  td.acoes-td { min-width: 140px; }
  .acoes-wrap { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
  .acoes-wrap .btn { padding: 0.08rem 0.35rem; line-height: 1.1; white-space: nowrap; }
  .docs-td .btn { border-radius: 10px; }
  .docs-td .dropdown-menu { min-width: 220px; }
  td.docs-td { min-width: 180px; }
  .table.table-sm td, .table.table-sm th { padding: 0.32rem 0.5rem; }
  /* Impedir que dropdown seja cortado pelo overflow da tabela */
  .table { overflow: visible !important; }
  .dropdown-menu { z-index: 2000; }
  /* CabeÃ§alho fixo durante a rolagem da pÃ¡gina */
  table.table thead th { position: sticky; top: 0; z-index: 3; background: #212529; color: #fff; }
</style>

<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input type="text" name="marca_modelo" value="{{ filtros.marca_modelo }}" class="form-control" placeholder="ğŸ”¤ Marca ou Modelo">
  </div>
  <div class="col-md-2">
    <input type="text" name="placa" value="{{ filtros.placa }}" class="form-control" placeholder="ğŸ“ Placa">
  </div>
  <div class="col-md-2">
    <input type="text" name="renavam" value="{{ filtros.renavam }}" class="form-control" placeholder="ğŸ“ Renavam">
  </div>
  <div class="col-md-2">
    <select name="combustivel" class="form-control">
      <option value="">â›½ CombustÃ­vel</option>
      {% for c in ["Gasolina", "Etanol", "Flex", "ElÃ©trico"] %}
        <option value="{{ c }}" {% if filtros.combustivel == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_min" value="{{ filtros.ano_min }}" class="form-control" placeholder="ğŸ“† Ano mÃ­n">
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_max" value="{{ filtros.ano_max }}" class="form-control" placeholder="ğŸ“† Ano mÃ¡x">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_min" value="{{ filtros.km_min }}" class="form-control" placeholder="ğŸ›£ï¸ Km mÃ­n">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_max" value="{{ filtros.km_max }}" class="form-control" placeholder="ğŸ›£ï¸ Km mÃ¡x">
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_min" value="{{ filtros.preco_min }}" class="form-control" placeholder="ğŸ’° PreÃ§o mÃ­n">
    {% endif %}
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_max" value="{{ filtros.preco_max }}" class="form-control" placeholder="ğŸ’° PreÃ§o mÃ¡x">
    {% endif %}
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">ğŸ” Filtrar</button>
  </div>
</form>

{% if motos %}
<table class="table table-bordered table-striped table-sm">
  <thead class="table-dark">
    <tr>
      <th>#</th><th>Marca</th><th>Modelo</th><th>Ano</th><th>Cor</th>
      <th>Km</th>
      {% if session.tipo == 'admin' %}
        <th>PreÃ§o cadastrado</th><th>Vendido por</th><th>Lucro</th>
      {% endif %}
      <th>Placa</th><th>CombustÃ­vel</th><th>Status</th><th>Data</th><th>Foto</th><th>Documentos</th><th>Documentos Venda</th><th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody>
    {% for m in motos %}
    {% set st = (m[9] or '')|lower %}
    <tr class="{% if st == 'consignado' %}consignado-row{% endif %}">
      <td>{{ loop.index }}</td><td>{{ m[1] }}</td><td>{{ m[2] }}</td><td>{{ m[3] }}</td><td>{{ m[4] }}</td>
      <td>{{ m[5]|br_km }}</td>
      {% if session.tipo == 'admin' %}
        <td>{{ m[6]|br_moeda }}</td>
        <td>
          {% set pv = sale_prices.get(m[0]) if sale_prices else None %}
          {% if pv is not none %}
            {{ pv|br_moeda }}
          {% else %}
            â€”
          {% endif %}
        </td>
        <td>
          {% if pv is not none %}
            {% set lucro = pv - (m[6]|float) %}
            {{ lucro|br_moeda }}
          {% else %}
            â€”
          {% endif %}
        </td>
      {% endif %}
      <td>{{ m[7] }}</td>
      <td>{{ m[8] }}</td>
      <td>
        {% if st == 'vendida' %}
          <span style="color: red; font-weight: bold;">Vendida</span>
        {% elif st == 'consignado' %}
          <span style="color: red; font-weight: bold;">Consignado</span>
        {% else %}
          <span>{{ m[9]|capitalize }}</span>
        {% endif %}
      </td>
      <td>
        {% set dv = sale_dates.get(m[0]) if sale_dates else None %}
        {{ dv if dv else 'â€”' }}
      </td>
      <td>
        {% if foto_urls and (m[0] in foto_urls) %}
          <a href="{{ foto_urls[m[0]] }}" target="_blank" title="Foto da Moto">
            <img src="{{ foto_urls[m[0]] }}" alt="Foto da Moto" class="img-thumbnail me-1" style="height:48px; width:auto;">
          </a>
        {% else %}
          â€”
        {% endif %}
      </td>
      <td class="docs-td" style="vertical-align: top;">
        <div class="btn-group dropdown position-static">
          <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            ğŸ“ Documentos
          </button>
          <ul class="dropdown-menu">
            {% set doc_url = file_url(m[12]) %}
            {% if doc_url %}
              <li><a class="dropdown-item" href="{{ doc_url }}" target="_blank">ğŸ“„ Documento Moto</a></li>
            {% endif %}
            {% set documento_fornecedor_url = file_url(m[13]) %}
            {% if documento_fornecedor_url %}
              <li><a class="dropdown-item" href="{{ documento_fornecedor_url }}" target="_blank">ğŸ· Fornecedor</a></li>
            {% endif %}
            {% set resid_url = file_url(m[14]) %}
            {% if resid_url %}
              <li><a class="dropdown-item" href="{{ resid_url }}" target="_blank">ğŸ  Comprovante de ResidÃªncia</a></li>
            {% endif %}
            {% if procuracao_urls and procuracao_urls.get(m[0]) %}
              <li><a class="dropdown-item" href="{{ procuracao_urls.get(m[0]) }}" target="_blank">ğŸ“ ProcuraÃ§Ã£o</a></li>
            {% endif %}
            {% if not (doc_url or documento_fornecedor_url or resid_url or (procuracao_urls and procuracao_urls.get(m[0])) or (anexos_venda and anexos_venda.get(m[0]) and anexos_venda.get(m[0])['cnh'])) %}
              <li><span class="dropdown-item text-muted">Sem documentos</span></li>
            {% endif %}
          </ul>
        </div>
      </td>
      <td class="docs-td" style="vertical-align: top;">
        {% set venda_docs = anexos_venda.get(m[0]) if anexos_venda else None %}
        {% if venda_docs and (venda_docs['cnh'] or venda_docs['garantia'] or venda_docs['endereco']) %}
          <div class="btn-group dropdown position-static">
            <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              ğŸ“ Documentos Venda
            </button>
            <ul class="dropdown-menu">
              {% if venda_docs['cnh'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['cnh'] }}" target="_blank">ğŸªª CNH</a></li>
              {% endif %}
              {% if venda_docs['garantia'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['garantia'] }}" target="_blank">ğŸ“‹ Garantia</a></li>
              {% endif %}
              {% if venda_docs['endereco'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['endereco'] }}" target="_blank">ğŸ  EndereÃ§o</a></li>
              {% endif %}
            </ul>
          </div>
        {% else %}
          â€”
        {% endif %}
      </td>
      <td class="acoes-td">
        {% if session.tipo in ['admin','vendedor'] %}
          <div class="acoes-wrap">
            <a class="btn btn-sm btn-outline-secondary" href="/editar_moto/{{ m[0] }}">âœï¸ Editar</a>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalGarantia" data-moto-id="{{ m[0] }}">ğŸ“ Anexar Garantia</button>
            {% if session.tipo == 'admin' %}
              <a class="btn btn-sm btn-outline-danger" href="/excluir_moto/{{ m[0] }}" onclick="return confirm('Confirma exclusÃ£o desta moto? Esta aÃ§Ã£o nÃ£o pode ser desfeita.');">ğŸ—‘ï¸ Excluir</a>
            {% endif %}
          </div>
        {% else %}
          â€”
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <div class="alert alert-info">Nenhuma moto vendida encontrada com os filtros aplicados.</div>
{% endif %}

<!-- Modal: Anexar Garantia -->
<div class="modal fade" id="modalGarantia" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formGarantia" method="POST" action="#" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Anexar Garantia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Arquivo da Garantia (PDF, imagem)</label>
            <input type="file" class="form-control" name="garantia" accept=".pdf,image/*" required>
          </div>
          <div class="text-muted small">O arquivo serÃ¡ vinculado Ã  Ãºltima venda desta moto.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const modalGarantia = document.getElementById('modalGarantia');
  if (modalGarantia) {
    modalGarantia.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;
      const motoId = button.getAttribute('data-moto-id');
      const form = document.getElementById('formGarantia');
      form.action = `/upload_garantia/${motoId}`;
    });
  }
</script>

{% endblock %}
