{% extends "layout_base.html" %}
{% block titulo %}Motos Vendidas{% endblock %}
{% block content %}
<h4>üèÅ Motos Vendidas</h4>
<style>
  /* Destacar motos consignadas (vermelho claro) na listagem de vendidas se aparecerem */
  tr.consignado-row { background-color: #ffe5e5; }
  .table.table-sm { font-size: 0.8rem; line-height: 1.1; }
  .table.table-sm img.img-thumbnail { height: 28px !important; }
  td.acoes-td { min-width: 130px; }
  .acoes-wrap { display: flex; flex-wrap: wrap; gap: 2px; align-items: center; }
  .acoes-wrap .btn { padding: 0.05rem 0.25rem; line-height: 1; font-size: 0.75rem; white-space: nowrap; }
  .docs-td .btn { border-radius: 8px; font-size: 0.75rem; padding: 0.12rem 0.35rem; }
  .docs-td .dropdown-menu { min-width: 200px; font-size: 0.8rem; }
  td.docs-td { min-width: 150px; }
  .table.table-sm td, .table.table-sm th { padding: 0.15rem 0.25rem; }
  /* Impedir que dropdown seja cortado pelo overflow da tabela */
  .table { overflow: visible !important; }
  .dropdown-menu { z-index: 2000; }
  /* Cabe√ßalho fixo durante a rolagem da p√°gina */
  table.table thead th { 
    position: sticky; 
    top: 0; 
    z-index: 3; 
    background: #212529; 
    color: #fff; 
    font-size: 0.85rem;
    padding: 0.3rem 0.5rem;
  }
  /* Estilo para c√©lula de data */
  td.data-venda {
    white-space: nowrap;
    min-width: 110px;
  }
  .data-venda .editar-data {
    margin-left: 5px;
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.2s;
  }
  .data-venda .editar-data:hover {
    opacity: 1;
  }
</style>

<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input type="text" name="marca_modelo" value="{{ filtros.marca_modelo }}" class="form-control" placeholder="üî§ Marca ou Modelo">
  </div>
  <div class="col-md-2">
    <input type="text" name="placa" value="{{ filtros.placa }}" class="form-control" placeholder="üìç Placa">
  </div>
  <div class="col-md-2">
    <input type="text" name="renavam" value="{{ filtros.renavam }}" class="form-control" placeholder="üìù Renavam">
  </div>
  <div class="col-md-2">
    <select name="combustivel" class="form-control">
      <option value="">‚õΩ Combust√≠vel</option>
      {% for c in ["Gasolina", "Etanol", "Flex", "El√©trico"] %}
        <option value="{{ c }}" {% if filtros.combustivel == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_min" value="{{ filtros.ano_min }}" class="form-control" placeholder="üìÜ Ano m√≠n">
  </div>
  <div class="col-md-2">
    <input type="number" name="ano_max" value="{{ filtros.ano_max }}" class="form-control" placeholder="üìÜ Ano m√°x">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_min" value="{{ filtros.km_min }}" class="form-control" placeholder="üõ£Ô∏è Km m√≠n">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="km_max" value="{{ filtros.km_max }}" class="form-control" placeholder="üõ£Ô∏è Km m√°x">
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_min" value="{{ filtros.preco_min }}" class="form-control" placeholder="üí∞ Pre√ßo m√≠n">
    {% endif %}
  </div>
  <div class="col-md-2">
    {% if session.tipo == 'admin' %}
    <input type="number" step="0.01" name="preco_max" value="{{ filtros.preco_max }}" class="form-control" placeholder="üí∞ Pre√ßo m√°x">
    {% endif %}
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">üîé Filtrar</button>
  </div>
  <div class="col-md-2">
    <input type="month" name="periodo" value="{{ periodo or '' }}" class="form-control" placeholder="üìÖ M√™s (sa√≠da)">
  </div>
  <div class="col-md-2">
    <a href="/motos_vendidas" class="btn btn-outline-secondary w-100">Limpar</a>
  </div>
</form>

{% if periodo %}
  <div class="alert alert-info py-2">Vendidas em {{ periodo }}: <strong>{{ motos|length }}</strong></div>
{% endif %}

{% if motos %}
<table class="table table-bordered table-striped table-sm">
  <thead class="table-dark">
    <tr>
      <th>#</th><th>Marca</th><th>Modelo</th><th>Ano</th><th>Cor</th>
      <th>Km</th>
      {% if session.tipo == 'admin' %}
        <th>Pre√ßo cadastrado</th><th>Vendido por</th><th>Lucro</th>
      {% endif %}
      <th>Placa</th><th>Combust√≠vel</th><th>Status</th><th>Data de Sa√≠da</th><th>Foto</th><th>Documentos</th><th>Documentos Venda</th><th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody>
    {% for m in motos %}
    {% set st = (m[9] or '')|lower %}
    <tr class="{% if st == 'consignado' %}consignado-row{% endif %}">
      <td>{{ loop.index }}</td><td>{{ m[1] }}</td><td>{{ m[2] }}</td><td>{{ m[3] }}</td><td>{{ m[4] }}</td>
      <td>{{ m[5]|br_km }}</td>
      {% if session.tipo == 'admin' %}
        <td>{{ m[6]|br_moeda }}</td>
        <td>
          {% set pv = sale_prices.get(m[0]) if sale_prices else None %}
          {% if pv is not none %}
            <span class="valor-venda">{{ pv|br_moeda }}</span>
          {% else %}
            <span class="valor-venda">‚Äî</span>
          {% endif %}
          {% if session.tipo == 'admin' %}
            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" data-bs-toggle="modal" data-bs-target="#modalEditarPreco" data-moto-id="{{ m[0] }}" data-preco-atual="{{ pv if pv is not none else '' }}" title="Editar pre√ßo de venda">‚úèÔ∏è</button>
          {% endif %}
        </td>
        <td>
          {% if pv is not none %}
            {% set lucro = pv - (m[6]|float) %}
            {{ lucro|br_moeda }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      {% endif %}
      <td>{{ m[7] }}</td>
      <td>{{ m[8] }}</td>
      <td>
        {% if st == 'vendida' %}
          <span style="color: red; font-weight: bold;">Vendida</span>
        {% elif st == 'consignado' %}
          <span style="color: red; font-weight: bold;">Consignado</span>
        {% else %}
          <span>{{ m[9]|capitalize }}</span>
        {% endif %}
      </td>
      <td class="data-venda">
        {% set dv = sale_dates.get(m[0]) if sale_dates else None %}
        {% if dv %}
          {% set data_part = dv.split(' ')[0] %}
          {% set hora_part = (dv.split(' ')[1] if (dv|length>10 and ' ' in dv) else '') %}
          {% if '-' in data_part %}
            {% set p = data_part.split('-') %}
            <span class="data-text">{{ p[2] }}/{{ p[1] }}/{{ p[0] }}{% if hora_part %} {{ hora_part[:5] }}{% endif %}</span>
          {% else %}
            <span class="data-text">{{ dv }}</span>
          {% endif %}
        {% else %}
          <span class="data-text">‚Äî</span>
        {% endif %}
        {% if session.tipo in ['admin','vendedor'] %}
          <span class="editar-data" data-bs-toggle="modal" data-bs-target="#modalEditarData" data-moto-id="{{ m[0] }}" data-data-atual="{{ dv if dv else '' }}" title="Editar data">
            ‚úèÔ∏è
          </span>
        {% endif %}
      </td>
      <td>
        {% if foto_urls and (m[0] in foto_urls) %}
          <a href="{{ foto_urls[m[0]] }}" target="_blank" title="Foto da Moto">
            <img src="{{ foto_urls[m[0]] }}" alt="Foto da Moto" class="img-thumbnail me-1" style="height:48px; width:auto;">
          </a>
        {% else %}
          ‚Äî
        {% endif %}
      </td>
      <td class="docs-td" style="vertical-align: top;">
        <div class="btn-group dropdown position-static">
          <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            üìé Documentos
          </button>
          <ul class="dropdown-menu">
            {% set doc_url = file_url(m[12]) %}
            {% if doc_url %}
              <li><a class="dropdown-item" href="{{ doc_url }}" target="_blank">üìÑ Documento Moto</a></li>
            {% endif %}
            {% set documento_fornecedor_url = file_url(m[13]) %}
            {% if documento_fornecedor_url %}
              <li><a class="dropdown-item" href="{{ documento_fornecedor_url }}" target="_blank">üè∑ Fornecedor</a></li>
            {% endif %}
            {% set resid_url = file_url(m[14]) %}
            {% if resid_url %}
              <li><a class="dropdown-item" href="{{ resid_url }}" target="_blank">üè† Comprovante de Resid√™ncia</a></li>
            {% endif %}
            {% if procuracao_urls and procuracao_urls.get(m[0]) %}
              <li><a class="dropdown-item" href="{{ procuracao_urls.get(m[0]) }}" target="_blank">üìù Procura√ß√£o</a></li>
            {% endif %}
            {% if not (doc_url or documento_fornecedor_url or resid_url or (procuracao_urls and procuracao_urls.get(m[0])) or (anexos_venda and anexos_venda.get(m[0]) and anexos_venda.get(m[0])['cnh'])) %}
              <li><span class="dropdown-item text-muted">Sem documentos</span></li>
            {% endif %}
          </ul>
        </div>
      </td>
      <td class="docs-td" style="vertical-align: top;">
        {% set venda_docs = anexos_venda.get(m[0]) if anexos_venda else None %}
        {% if venda_docs and (venda_docs['cnh'] or venda_docs['garantia'] or venda_docs['endereco']) %}
          <div class="btn-group dropdown position-static">
            <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              üìé Documentos Venda
            </button>
            <ul class="dropdown-menu">
              {% if venda_docs['cnh'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['cnh'] }}" target="_blank">ü™™ CNH</a></li>
              {% endif %}
              {% if venda_docs['garantia'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['garantia'] }}" target="_blank">üìã Garantia</a></li>
              {% endif %}
              {% if venda_docs['endereco'] %}
                <li><a class="dropdown-item" href="{{ venda_docs['endereco'] }}" target="_blank">üè† Endere√ßo</a></li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/gerar_garantia/{{ m[0] }}" target="_blank">üßæ Gerar Garantia (PDF)</a></li>
            </ul>
          </div>
        {% else %}
          <div class="btn-group dropdown position-static">
            <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              üìé Documentos Venda
            </button>
            <ul class="dropdown-menu">
              <li><span class="dropdown-item text-muted">Sem anexos de venda</span></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/gerar_garantia/{{ m[0] }}" target="_blank">üßæ Gerar Garantia (PDF)</a></li>
            </ul>
          </div>
        {% endif %}
      </td>
      <td class="acoes-td">
        {% if session.tipo in ['admin','vendedor'] %}
          <div class="acoes-wrap">
            <a class="btn btn-sm btn-outline-secondary" href="/editar_moto/{{ m[0] }}" title="Editar moto">‚úèÔ∏è</a>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalGarantia" data-moto-id="{{ m[0] }}" title="Anexar garantia">üìé</button>
            {% if session.tipo == 'admin' %}
              <a class="btn btn-sm btn-outline-danger" href="/excluir_moto/{{ m[0] }}" onclick="return confirm('Confirma exclus√£o desta moto? Esta a√ß√£o n√£o pode ser desfeita.');">üóëÔ∏è Excluir</a>
            {% endif %}
          </div>
        {% else %}
          ‚Äî
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
  {% if session.tipo == 'admin' and lucros_por_mes %}
    <div class="card mt-3">
      <div class="card-header">Resumo de Lucros por M√™s</div>
      <div class="card-body p-2">
        <table class="table table-sm mb-0">
          <thead>
            <tr><th>M√™s (YYYY-MM)</th><th class="text-end">Lucro Total</th></tr>
          </thead>
          <tbody>
            {% for mes, total in lucros_por_mes.items() %}
              <tr>
                <td>{{ mes }}</td>
                <td class="text-end">{{ total|br_moeda }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
{% else %}
  <div class="alert alert-info">Nenhuma moto vendida encontrada com os filtros aplicados.</div>
{% endif %}

<!-- Modal: Anexar Garantia -->
<div class="modal fade" id="modalGarantia" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formGarantia" method="POST" action="#" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Anexar Garantia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Arquivo da Garantia (PDF, imagem)</label>
            <input type="file" class="form-control" name="garantia" accept=".pdf,image/*" required>
          </div>
          <div class="text-muted small">O arquivo ser√° vinculado √† √∫ltima venda desta moto.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Editar Data da Venda -->
<div class="modal fade" id="modalEditarData" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarData" method="POST" action="/atualizar_data_venda">
        <input type="hidden" name="moto_id" id="motoId">
        <div class="modal-header">
          <h5 class="modal-title">Editar Data de Sa√≠da</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="dataVenda" class="form-label">Data de Sa√≠da</label>
            <input type="date" class="form-control" id="dataVenda" name="data_venda" required>
          </div>
          <div class="mb-3">
            <label for="horaVenda" class="form-label">Hora de Sa√≠da</label>
            <input type="time" class="form-control" id="horaVenda" name="hora_venda">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Editar Pre√ßo da Venda (Admin) -->
<div class="modal fade" id="modalEditarPreco" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarPreco" method="POST" action="/atualizar_preco_venda">
        <input type="hidden" name="moto_id" id="motoIdPreco">
        <div class="modal-header">
          <h5 class="modal-title">Editar Pre√ßo da Venda</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="precoFinal" class="form-label">Pre√ßo Final</label>
            <input type="text" class="form-control" id="precoFinal" name="preco_final" placeholder="R$ 0,00" required>
            <div class="form-text">Use v√≠rgula para centavos. Ex.: 1.234,56</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
  </div>

<script>
  // Configura√ß√£o do modal de garantia
  const modalGarantia = document.getElementById('modalGarantia');
  if (modalGarantia) {
    modalGarantia.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;
      const motoId = button.getAttribute('data-moto-id');
      const form = document.getElementById('formGarantia');
      form.action = `/upload_garantia/${motoId}`;
    });
  }

  // Configura√ß√£o do modal de edi√ß√£o de data
  const modalEditarData = document.getElementById('modalEditarData');
  if (modalEditarData) {
    modalEditarData.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const motoId = button.getAttribute('data-moto-id');
      const dataAtual = button.getAttribute('data-data-atual') || '';

      // Preenche o formul√°rio com os dados atuais
      document.getElementById('motoId').value = motoId;

      // Extrai data e hora (se houver) e normaliza
      let isoDate = '';
      let timePart = '';
      const parts = dataAtual.split(' ');
      const onlyDate = parts[0] || '';
      if (parts.length > 1) timePart = parts[1].slice(0,5);

      if (onlyDate.includes('/')) {
        const [dia, mes, ano] = onlyDate.split('/');
        isoDate = `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
      } else if (onlyDate.includes('-')) {
        isoDate = onlyDate.slice(0, 10);
      }

      document.getElementById('dataVenda').value = isoDate || new Date().toISOString().split('T')[0];
      document.getElementById('horaVenda').value = timePart || new Date().toTimeString().slice(0,5);
    });
  }
  
  // Fun√ß√£o para formatar a data ao enviar o formul√°rio
  document.addEventListener('DOMContentLoaded', function() {
    const formEditarData = document.getElementById('formEditarData');
    if (formEditarData) {
      formEditarData.addEventListener('submit', function(e) {
        const dataInput = document.getElementById('dataVenda');
        if (dataInput.value) {
          // Converte a data para o formato brasileiro para exibi√ß√£o
          const [ano, mes, dia] = dataInput.value.split('-');
          dataInput.value = `${ano}-${mes}-${dia}`; // Mant√©m o formato YYYY-MM-DD para o servidor
        }
      });
    }
  });

  // Configura√ß√£o do modal de edi√ß√£o de pre√ßo (admin)
  const modalEditarPreco = document.getElementById('modalEditarPreco');
  if (modalEditarPreco) {
    modalEditarPreco.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const motoId = button.getAttribute('data-moto-id');
      const precoAtual = button.getAttribute('data-preco-atual') || '';
      document.getElementById('motoIdPreco').value = motoId;
      const input = document.getElementById('precoFinal');
      if (precoAtual) {
        // Se veio n√∫mero puro, formatar; se j√° veio BRL, manter
        let val = precoAtual;
        if (!isNaN(parseFloat(precoAtual))) {
          try {
            let br = (parseFloat(precoAtual)).toFixed(2).replace('.', ',');
            br = br.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            val = 'R$ ' + br;
          } catch(e) {}
        }
        input.value = val.toString().startsWith('R$') ? val : ('R$ ' + val);
      } else {
        input.value = '';
      }
    });
    // M√°scara simples BRL
    const precoInput = document.getElementById('precoFinal');
    precoInput.addEventListener('input', function(e){
      let value = e.target.value.replace(/\D/g, '');
      value = (value / 100).toFixed(2);
      value = value.replace('.', ',');
      value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      e.target.value = 'R$ ' + value;
    });
  }
</script>

{% endblock %}
